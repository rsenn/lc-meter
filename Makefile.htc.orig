-include Makefile.vars


vpath $(BUILDDIR)

VERSION = $(VERSION_MAJOR).$(VERSION_MINOR).$(VERSION_PATCH)


ifeq ($(COMPILER),)
COMPILER := htc
endif

PROGRAMFILES = C:/Program Files (x86)

ifeq ($(shell which picc),)
ifeq ($(shell uname -o),GNU/Linux)
CC = picc
else
ifeq ($(COMPILER),xc8)
CCVER = 1.34
CCDIR = /opt/microchip/xc8/v$(CCVER)
else
CCVER = 9.83
CCDIR = "$(PROGRAMFILES)"/HI-TECH\ Software/PICC/$(CCVER)
endif
endif
endif

ifneq ($(CCDIR),)
CC = $(CCDIR)/bin/picc
else
CC = picc
endif

COMPILER_TYPE := $(shell $(CC) --ver 2>&1 |sed -n '{ s,.* MPLAB ,, ; s,\([^ ]\+\) C Compiler.*,\1,p }' |  tr "[[:upper:]]" "[[:lower:]]")

$(warning Compiler: $(CC))
$(warning Compiler type: $(COMPILER_TYPE))

ifeq ($(COMPILER_TYPE),xc8)
BUILDDIR := build/xc8-$(chipl)/
else
BUILDDIR := build/htc-$(chipl)/
endif

LD = $(CC)
#RM = del /f
DISTFILES = Makefile Makefile.htc Makefile.sdcc


SOURCES = $($(PROGRAM)_SOURCES)
P1OBJS = $(SOURCES:%.c=$(BUILDDIR)%.p1)
ASSRCS = $(SOURCES:%.c=$(BUILDDIR)%.as)

COMMON_FLAGS = -g -N127
#COMMON_FLAGS = -g

#COMMON_FLAGS += --runtime="default,+clear,+init,-keep,-download,+clib"
COMMON_FLAGS +=	--runtime="default,+clear,+init,-keep,+osccal,-download,-resetbits,+stackcall,+clib"
#COMMON_FLAGS += --opt="default,+asm,-speed,+space,9"

ifeq ($(OPT),size)
COMMON_FLAGS += --opt="default,+asm,+space,-speed,9"
else
COMMON_FLAGS += --opt="default,+asm,-space,+speed,9"
endif

COMMON_FLAGS += --double=32 --float=24
COMMON_FLAGS += --warn=-2

COMMON_FLAGS += --errformat="Error   [%n] %f; %l.%c %s"
COMMON_FLAGS += --msgformat="Advisory[%n] %s"
COMMON_FLAGS += --warnformat="Warning [%n] %f; %l.%c %s"

CPPFLAGS += -D__$(chipl)=1

ifneq ($(CCDIR),)
CPPFLAGS += -I$(CCDIR)/include
endif

_CPPFLAGS += \
	-DVERSION_MAJOR=$(VERSION_MAJOR) \
	-DVERSION_MINOR=$(VERSION_MINOR) \
	-DVERSION_PATCH=$(VERSION_PATCH)

CFLAGS = -q -P \
	--chip="$(chipu)" \
	--addrqual=ignore \
	--asmlist

CFLAGS += $(COMMON_FLAGS)

_LDFLAGS += --summary=default,-psect,-class,+mem,-hex

LDFLAGS += --output=default,-inhx032 --chip=$(chipl)


  LDFLAGS +=  --asmlist

PM3CMD = "$$PROGRAMFILES"/Microchip/MPLAB\ IDE/Programmer\ Utilities/PM3Cmd/PM3Cmd

all: $(BUILDDIR) $(PACKAGE).hex


$(PACKAGE).hex: $(P1OBJS)

	$(LD) $(LDFLAGS) -m$(BUILDDIR)LC-meter-HD44780.map -o$(BUILDDIR)$@ $^ || { $(RM) $(BUILDDIR)$(PACKAGE).hex; exit 1; }

$(P1OBJS): $(BUILDDIR)%.p1: %.c
	$(CC) --pass1 $(CFLAGS) $(CPPFLAGS) --outdir=$(BUILDDIR:%/=%) $< # || { $(RM) $@; exit 1; }
$(ASSRCS): $(BUILDDIR)%.as: %.c
	$(CC) -S $(CFLAGS) $(CPPFLAGS) -o$(BUILDDIR)$@ $< # || { $(RM) $@; exit 1; }



-include Makefile.common
