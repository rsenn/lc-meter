     1: #include "LC-meter.h"
     2: //#include "main.h"
     3: #include "delay.h"
     4: #include "interrupt.h"
     5: #if USE_HD44780_LCD
     6: #include "lcd44780.h"
     7: #endif
     8: #if USE_NOKIA3310_LCD
     9: #include "lcd3310.h"
    10: #endif
    11: #include "display.h"
    12: #include "timer.h"
    13: #include "uart.h"
    14: 
    15: #ifdef SDCC
    16: uint16_t __at(_CONFIG) __configword = CONFIG_WORD;
    17: #endif
    18: 
    19: #ifdef __XC__
    20: # pragma config WDTE = OFF, PWRTE = ON, CP = OFF, BOREN = ON, DEBUG = OFF, LVP = OFF, CPD = OFF, WRT = OFF, FOSC = HS
    21: #endif
    22: 
    23: #ifdef  HI_TECH_C
    24: __CONFIG(CONFIG_WORD);
    25: #endif
    26: 
    27: #define SET_LED(b) do { LED_PIN = !(b); } while(0);
    28: 
    29: #define FALLING 0
    30: #define RISING 1
    31: 
    32: #define CCP1_EDGE() (CCP1M0)
    33: /*
    34: volatile uint32 tcy_per_s = TCY_PER_SECOND;
    35: volatile uint32 tcy_per_ms = TCY_PER_MILLISECOND;
    36: volatile uint32 tcy_per_us = TCY_PER_MICROSECOND;
    37: volatile uint32 ktcy_per_s = KTCY_PER_SECOND;
    38: volatile uint32 ktcy_per_ms = KTCY_PER_MILLISECOND;
    39: */
    40: 
    41: volatile uint16 bres;
    42: volatile  uint16 seconds;
    43: volatile uint32 ccp1t_lr, ccp1t[2];
    44: 
    45: float F1, F2, F3;
    46: 
    47: static void initialize(void);
    48: 
    49: INTERRUPT()
    50: {
    51: 
    52:   /*  if (TMR2IF) {
    53:       tmr2_overflow++;
    54: 
    55: 
    56: 
    57: 
    58:       // Clear timer interrupt bit
    59:       TMR2IF = 0;
    60:     }*/
    61: 
    62:   if (T0IF) {
    63:     tmr0_overflow++;
    64: 
    65:     bres++;
    66:     if (bres >= 500) { // if reached 1 second!
    67:       bres -= 500;  // subtract 1 second, retain error
    68:       seconds++;  // update clock, etc
    69: 
    70:       SET_LED(seconds & 1);
    71:     }
    72:     TMR0 = -64;
    73:     T0IF = 0;
    74:   }
    75: 
    76: #ifdef USE_TIMER_1
    77:   if (CCP1IF) {
    78: 
    79:     if (CCP1_EDGE() == RISING) {
    80:       ccp1t_lr = ccp1t[RISING];
    81:     }
    82:     ccp1t[CCP1_EDGE()] = CCPR1 + ((uint32)tmr1_overflow << 16);
    83:     CCP1IE = 0;
    84:     CCP1_EDGE() = !CCP1_EDGE();
    85:     CCP1IE = 1;
    86:     CCP1IF = 0;
    87:   }
    88: #endif
    89: }
    90: 
    91: void
    92: main(void)
    93: {
    94:   /*
    95:     tcy_per_s = TCY_PER_SECOND;
    96:   tcy_per_ms = TCY_PER_MILLISECOND;
    97:   tcy_per_us = TCY_PER_MICROSECOND;
    98:   ktcy_per_s = KTCY_PER_SECOND;
    99:   ktcy_per_ms = KTCY_PER_MILLISECOND;
   100:   */
   101:   initialize();
   102: 
   103: #if USE_HD44780_LCD     || USE_NOKIA3310_LCD
   104:   lcd_set_cursor(0,0);
   105: 
   106:   lcd_print("LC-meter");
   107: 
   108: #endif
   109:   uart_puts("LC-meter\r\n");
   110: 
   111: #if 0
   112:   RELAY_TRIS();
   113:   for (int i = 0; i < 10; i++) {
   114:     RC5 = HIGH;
   115:     __delay_ms(500);
   116:     RC5 = LOW;
   117:     __delay_ms(500);
   118:   }
   119: #endif
   120: 
   121:   for (;;) {
   122:     bool led_value = 0;
   123: #if USE_HD44780_LCD    || USE_NOKIA3310_LCD
   124: 
   125:     lcd_set_cursor(0,1);
   126:     display_print_number(ccp1t[1] - ccp1t_lr, 16, -4);
   127:     //    display_print_number(measure_freq(), 16, 4);
   128: #endif
   129:     //  SET_LED(led_value = !led_value);
   130:   }
   131: }
   132: 
   133: void
   134: setup_ccp1()
   135: {
   136: 
   137:   ccp1t_lr = ccp1t[0] = ccp1t[1] = (int16)-1;
   138: 
   139:   TRISC2 = INPUT;
   140:   CCP1CONbits.CCP1M = 0b0100;
   141:   CCP1IE = 1;
   142:   CCP1IF = 0;
   143: }
   144: 
   145: static void
   146: initialize(void)
   147: {
   148:   //setup comparator
   149:   /*CMCONbits.*/CM0 = 1;
   150:   /*CMCONbits.*/CM1 = 0;
   151:   /*CMCONbits.*/CM2 = 1;
   152: 
   153:   TRISA = 0b11001111;
   154: 
   155:   setup_timer0();
   156:   T0IE = 1;
   157:   T0IF = 0;
   158:   // setup_timer1();
   159:   // TMR1H = 0xff;
   160: 
   161:   // setup_timer2();
   162: 
   163: 
   164:   // setup_ccp1();
   165: 
   166:   //others
   167:   LC_TRIS();
   168:   NOT_RBPU = 1;  // enable portB internal pullup
   169: 
   170:   LED_TRIS = OUTPUT;
   171:   LED_PIN = HIGH;
   172: 
   173:   uart_init();
   174: 
   175:   RELAY_TRIS();
   176:   ADD_CCAL();
   177: 
   178:   PEIE = 1;
   179:   GIE = 1;
   180: 
   181:   //initialize 3310 lcd
   182: #if USE_NOKIA3310_LCD
   183:   lcd_init();
   184:   lcd_clear();
   185: #elif USE_HD44780_LCD
   186:   lcd_init(true);
   187:   lcd_begin(2, 1);
   188: #endif
   189: }
   190: 
   191: uint16
   192: measure_freq(void)    //16-bit freq
   193: {
   194: 
   195:   TRISA4 = 0;    //Enable RA4 output to T0CKI
   196: 
   197:   tmr0_overflow = 0;
   198:   TMR0 = 0x00;
   199:   TMR0IF = 0;    //clear timer0 interrupt flag
   200:   TMR0IE = 1;
   201: 
   202:   __delay_ms(1000);
   203: 
   204:   TRISA4 = 1;    //Disable RA4 output to T0CKI
   205:   TMR0IE = 0;
   206: 
   207:   return (tmr0_overflow << 8) | TMR0;
   208: }
   209: 
   210: void
   211: calibrate(void)
   212: {
   213: 
   214: }
   215: 
   216: void
   217: measure_capacitance()
   218: {
   219: 
   220: }
   221: 
   222: void
   223: measure_inductance()
   224: {
   225: 
   226: }
   227: 
   228: void
   229: delay10ms(uint16 period_10ms)
   230: {
   231:   do {
   232:     __delay_ms(10);
   233:   } while (--period_10ms);
   234: }
   235: 
